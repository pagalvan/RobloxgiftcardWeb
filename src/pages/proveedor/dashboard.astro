---
import {
  Package,
  LayoutGrid,
  Store,
  LogOut,
  Ticket,
  CheckCircle2,
  Clock,
} from "lucide-react";
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";
import { formatDate } from "../../lib/utils";

// Verificar autenticación y rol de proveedor
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/auth/login");
}

const { data: user } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", session.user.id)
  .single();

if (user?.role !== "proveedor" && user?.role !== "admin") {
  return Astro.redirect("/tienda");
}

// Manejar agregar código
let message = "";
let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action")?.toString();

  if (action === "add_code") {
    const giftcardId = formData.get("giftcard_id")?.toString();
    const code = formData.get("code")?.toString();

    if (!giftcardId || !code) {
      error = "Todos los campos son requeridos";
    } else {
      // Verificar que el código no exista
      const { data: existing } = await supabase
        .from("giftcard_codes")
        .select("id")
        .eq("code", code)
        .single();

      if (existing) {
        error = "Este código ya existe en el sistema";
      } else {
        const { error: insertError } = await supabase
          .from("giftcard_codes")
          .insert({
            giftcard_id: giftcardId,
            code: code,
            provider_id: session.user.id,
            is_sold: false,
            is_redeemed: false,
          });

        if (insertError) {
          error = insertError.message;
        } else {
          // Incrementar stock de la giftcard
          const { data: giftcard } = await supabase
            .from("giftcards")
            .select("stock")
            .eq("id", giftcardId)
            .single();

          if (giftcard) {
            await supabase
              .from("giftcards")
              .update({ stock: giftcard.stock + 1 })
              .eq("id", giftcardId);
          }

          message = "Código agregado exitosamente";
        }
      }
    }
  } else if (action === "add_bulk") {
    const giftcardId = formData.get("giftcard_id")?.toString();
    const codes = formData.get("codes")?.toString();

    if (!giftcardId || !codes) {
      error = "Todos los campos son requeridos";
    } else {
      const codeList = codes
        .split("\n")
        .map((c: string) => c.trim())
        .filter((c: string) => c.length > 0);
      let added = 0;
      let duplicates = 0;

      for (const code of codeList) {
        const { data: existing } = await supabase
          .from("giftcard_codes")
          .select("id")
          .eq("code", code)
          .single();

        if (!existing) {
          await supabase.from("giftcard_codes").insert({
            giftcard_id: giftcardId,
            code: code,
            provider_id: session.user.id,
            is_sold: false,
            is_redeemed: false,
          });
          added++;
        } else {
          duplicates++;
        }
      }

      // Actualizar stock
      const { data: giftcard } = await supabase
        .from("giftcards")
        .select("stock")
        .eq("id", giftcardId)
        .single();

      if (giftcard) {
        await supabase
          .from("giftcards")
          .update({ stock: giftcard.stock + added })
          .eq("id", giftcardId);
      }

      message = `${added} códigos agregados${duplicates > 0 ? ` (${duplicates} duplicados ignorados)` : ""}`;
    }
  }
}

// Obtener giftcards disponibles
const { data: giftcards } = await supabase
  .from("giftcards")
  .select(
    `
    id,
    name,
    denomination,
    currency,
    category:giftcard_categories(name)
  `,
  )
  .eq("is_active", true)
  .order("name");

// Obtener códigos del proveedor
const { data: providerCodes } = await supabase
  .from("giftcard_codes")
  .select(
    `
    *,
    giftcard:giftcards(name, denomination, currency)
  `,
  )
  .eq("provider_id", session.user.id)
  .order("created_at", { ascending: false })
  .limit(50);

// Estadísticas
const { count: totalCodes } = await supabase
  .from("giftcard_codes")
  .select("*", { count: "exact", head: true })
  .eq("provider_id", session.user.id);

const { count: soldCodes } = await supabase
  .from("giftcard_codes")
  .select("*", { count: "exact", head: true })
  .eq("provider_id", session.user.id)
  .eq("is_sold", true);

const { count: availableCodes } = await supabase
  .from("giftcard_codes")
  .select("*", { count: "exact", head: true })
  .eq("provider_id", session.user.id)
  .eq("is_sold", false);
---

<Layout title="Panel Proveedor">
  <div class="min-h-screen bg-slate-900">
    <!-- Sidebar -->
    <aside
      class="fixed left-0 top-0 w-64 h-full bg-slate-800 border-r border-white/10 z-40"
    >
      <div class="p-6">
        <a href="/" class="flex items-center gap-2">
          <div
            class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center"
          >
            <Package className="w-6 h-6 text-white" client:load />
          </div>
          <span class="text-lg font-bold text-white">Proveedor</span>
        </a>
      </div>

      <nav class="px-4 space-y-1">
        <a
          href="/proveedor/dashboard"
          class="flex items-center gap-3 px-4 py-3 rounded-lg bg-blue-500/20 text-blue-400"
        >
          <LayoutGrid className="w-5 h-5" client:load />
          Dashboard
        </a>
        <a
          href="/tienda"
          class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white transition-all"
        >
          <Store className="w-5 h-5" client:load />
          Ver Tienda
        </a>
      </nav>

      <div
        class="absolute bottom-0 left-0 right-0 p-4 border-t border-white/10"
      >
        <div class="flex items-center gap-3 mb-4">
          <div
            class="w-10 h-10 bg-blue-500/20 rounded-full flex items-center justify-center text-blue-400 font-semibold"
          >
            {user?.full_name?.charAt(0).toUpperCase()}
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm text-white font-medium truncate">
              {user?.full_name}
            </p>
            <p class="text-xs text-gray-400">Proveedor</p>
          </div>
        </div>
        <a
          href="/auth/logout"
          class="flex items-center gap-2 px-4 py-2 text-red-400 hover:bg-red-500/10 rounded-lg text-sm w-full"
        >
          <LogOut className="w-4 h-4" client:load />
          Cerrar Sesión
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 p-8">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Panel de Proveedor</h1>
        <p class="text-gray-400 mt-1">
          Gestiona los códigos de giftcards que provees
        </p>
      </div>

      {
        message && (
          <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-6">
            <p class="text-green-400">{message}</p>
          </div>
        )
      }

      {
        error && (
          <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-4 mb-6">
            <p class="text-red-400">{error}</p>
          </div>
        )
      }

      <!-- Stats -->
      <div class="grid sm:grid-cols-3 gap-6 mb-8">
        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10">
          <div
            class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center mb-4"
          >
            <Ticket className="w-6 h-6 text-blue-400" client:load />
          </div>
          <p class="text-3xl font-bold text-white">{totalCodes || 0}</p>
          <p class="text-sm text-gray-400">Total Códigos Subidos</p>
        </div>

        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10">
          <div
            class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center mb-4"
          >
            <CheckCircle2 className="w-6 h-6 text-green-400" client:load />
          </div>
          <p class="text-3xl font-bold text-white">{soldCodes || 0}</p>
          <p class="text-sm text-gray-400">Códigos Vendidos</p>
        </div>

        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10">
          <div
            class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center mb-4"
          >
            <Clock className="w-6 h-6 text-yellow-400" client:load />
          </div>
          <p class="text-3xl font-bold text-white">{availableCodes || 0}</p>
          <p class="text-sm text-gray-400">Códigos Disponibles</p>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-8">
        <!-- Agregar Código Individual -->
        <div class="bg-slate-800/50 rounded-xl border border-white/10">
          <div class="p-6 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Agregar Código</h2>
            <p class="text-sm text-gray-400 mt-1">
              Agrega un código de giftcard individual
            </p>
          </div>
          <form method="POST" class="p-6 space-y-4">
            <input type="hidden" name="action" value="add_code" />

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2"
                >Seleccionar GiftCard</label
              >
              <select
                name="giftcard_id"
                required
                class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Seleccionar producto...</option>
                {
                  giftcards?.map((gc: any) => (
                    <option value={gc.id}>
                      {gc.name} - ${gc.denomination} {gc.currency}
                    </option>
                  ))
                }
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2"
                >Código de GiftCard</label
              >
              <input
                type="text"
                name="code"
                required
                class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white font-mono focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="XXXX-XXXX-XXXX-XXXX"
              />
            </div>

            <button
              type="submit"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition-all"
            >
              Agregar Código
            </button>
          </form>
        </div>

        <!-- Agregar Códigos en Lote -->
        <div class="bg-slate-800/50 rounded-xl border border-white/10">
          <div class="p-6 border-b border-white/10">
            <h2 class="text-lg font-semibold text-white">Agregar en Lote</h2>
            <p class="text-sm text-gray-400 mt-1">
              Agrega múltiples códigos a la vez (uno por línea)
            </p>
          </div>
          <form method="POST" class="p-6 space-y-4">
            <input type="hidden" name="action" value="add_bulk" />

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2"
                >Seleccionar GiftCard</label
              >
              <select
                name="giftcard_id"
                required
                class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">Seleccionar producto...</option>
                {
                  giftcards?.map((gc: any) => (
                    <option value={gc.id}>
                      {gc.name} - ${gc.denomination} {gc.currency}
                    </option>
                  ))
                }
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2"
                >Códigos (uno por línea)</label
              >
              <textarea
                name="codes"
                required
                rows="6"
                class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white font-mono focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
                placeholder="XXXX-XXXX-XXXX-XXXX
YYYY-YYYY-YYYY-YYYY
ZZZZ-ZZZZ-ZZZZ-ZZZZ"
              ></textarea>
            </div>

            <button
              type="submit"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium transition-all"
            >
              Agregar Códigos en Lote
            </button>
          </form>
        </div>
      </div>

      <!-- Historial de Códigos -->
      <div class="mt-8 bg-slate-800/50 rounded-xl border border-white/10">
        <div class="p-6 border-b border-white/10">
          <h2 class="text-lg font-semibold text-white">
            Mis Códigos Recientes
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-800">
              <tr>
                <th
                  class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase"
                  >Producto</th
                >
                <th
                  class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase"
                  >Código</th
                >
                <th
                  class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase"
                  >Estado</th
                >
                <th
                  class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase"
                  >Fecha</th
                >
              </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
              {
                providerCodes && providerCodes.length > 0 ? (
                  providerCodes.map((code: any) => (
                    <tr class="hover:bg-white/5">
                      <td class="px-6 py-4 text-white">
                        {code.giftcard?.name} - ${code.giftcard?.denomination}
                      </td>
                      <td class="px-6 py-4">
                        <code class="text-blue-400 font-mono text-sm">
                          {code.code.slice(0, 4)}****{code.code.slice(-4)}
                        </code>
                      </td>
                      <td class="px-6 py-4">
                        <span
                          class:list={[
                            "px-2 py-1 rounded-full text-xs font-medium",
                            code.is_sold
                              ? "bg-green-500/20 text-green-400"
                              : "bg-yellow-500/20 text-yellow-400",
                          ]}
                        >
                          {code.is_sold ? "Vendido" : "Disponible"}
                        </span>
                      </td>
                      <td class="px-6 py-4 text-gray-400 text-sm">
                        {formatDate(code.created_at)}
                      </td>
                    </tr>
                  ))
                ) : (
                  <tr>
                    <td
                      colspan="4"
                      class="px-6 py-12 text-center text-gray-400"
                    >
                      No has agregado códigos aún
                    </td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</Layout>
