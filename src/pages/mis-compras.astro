---
import Layout from "@/layouts/Layout.astro";
import { supabase, type UserProfile, type Purchase } from "@/lib/supabase";
import { formatDate } from "@/lib/utils";
import { ShoppingBag } from "lucide-react";
import StoreNavbar from "@/components/StoreNavbar.astro";

// Verificar autenticación
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/auth/login");
}

// Obtener perfil
const { data: user } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", session.user.id)
  .single();

// Obtener compras del usuario
const { data: purchases } = await supabase
  .from("purchases")
  .select(
    `
    *,
    giftcard:giftcards(name, denomination, currency, image_url),
    code:giftcard_codes(code)
  `,
  )
  .eq("user_id", session.user.id)
  .order("created_at", { ascending: false });
---

<Layout title="Mis Compras">
  <div class="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800">
    <StoreNavbar user={user as any} activePage="mis-compras" />

    <main class="container mx-auto px-4 py-8">
      <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-8">Mis Compras</h1>

        {
          purchases && purchases.length > 0 ? (
            <div class="space-y-4">
              {purchases.map((purchase: any) => (
                <div class="bg-slate-800/50 rounded-xl border border-white/10 p-6">
                  <div class="flex items-center gap-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-primary/20 to-primary/5 rounded-lg flex items-center justify-center shrink-0">
                      {purchase.giftcard?.image_url ? (
                        <img
                          src={purchase.giftcard.image_url}
                          alt={purchase.giftcard.name}
                          class="h-10 object-contain"
                        />
                      ) : (
                        <span class="text-2xl font-bold text-white/30">
                          {purchase.giftcard?.name?.charAt(0)}
                        </span>
                      )}
                    </div>

                    <div class="flex-1 min-w-0">
                      <div class="flex items-center gap-3 mb-1">
                        <h3 class="font-semibold text-white">
                          {purchase.giftcard?.name}
                        </h3>
                        <span class="bg-primary/20 text-primary text-xs font-bold px-2 py-0.5 rounded">
                          ${purchase.giftcard?.denomination}{" "}
                          {purchase.giftcard?.currency}
                        </span>
                      </div>
                      <p class="text-sm text-gray-400">
                        {formatDate(purchase.created_at)}
                      </p>
                    </div>

                    <div class="text-right">
                      <p class="text-lg font-bold text-white">
                        ${purchase.amount.toFixed(2)}
                      </p>
                      <span
                        class:list={[
                          "text-xs px-2 py-0.5 rounded-full",
                          purchase.status === "completed"
                            ? "bg-green-500/20 text-green-400"
                            : purchase.status === "pending"
                              ? "bg-yellow-500/20 text-yellow-400"
                              : "bg-red-500/20 text-red-400",
                        ]}
                      >
                        {purchase.status === "completed"
                          ? "Completada"
                          : purchase.status === "pending"
                            ? "Pendiente"
                            : "Fallida"}
                      </span>
                    </div>
                  </div>

                  {purchase.status === "completed" && purchase.code && (
                    <div class="mt-4 pt-4 border-t border-white/10">
                      <div class="flex items-center justify-between bg-slate-900/50 rounded-lg p-4">
                        <div>
                          <p class="text-xs text-gray-400 mb-1">Código:</p>
                          <code
                            id={`code-${purchase.id}`}
                            class="text-primary font-mono font-bold tracking-wider"
                          >
                            {purchase.code.code}
                          </code>
                        </div>
                        <button
                          onclick={`navigator.clipboard.writeText(document.getElementById('code-${purchase.id}').textContent.trim()); this.innerHTML = '✓ Copiado'; setTimeout(() => this.innerHTML = 'Copiar', 2000);`}
                          class="bg-primary/20 hover:bg-primary/30 text-primary px-4 py-2 rounded-lg text-sm font-medium transition-all"
                        >
                          Copiar
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center py-20">
              <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6">
                <ShoppingBag className="w-12 h-12 text-gray-600" client:load />
              </div>
              <h3 class="text-xl font-semibold text-white mb-2">
                No tienes compras aún
              </h3>
              <p class="text-gray-400 mb-8">
                ¡Explora nuestra tienda y encuentra tu giftcard favorita!
              </p>
              <a
                href="/tienda"
                class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium inline-block"
              >
                Ir a la Tienda
              </a>
            </div>
          )
        }
      </div>
    </main>
  </div>
</Layout>
