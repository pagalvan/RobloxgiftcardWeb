---
import Layout from "@/layouts/Layout.astro";
import {
  supabase,
  type GiftCard,
  type GiftCardCategory,
  type UserProfile,
} from "@/lib/supabase";
import { DollarSign, Inbox } from "lucide-react";
import StoreNavbar from "@/components/StoreNavbar.astro";

// Verificar autenticaci√≥n
const {
  data: { session },
} = await supabase.auth.getSession();
let user: UserProfile | null = null;

if (session) {
  const { data } = await supabase
    .from("profiles")
    .select("*")
    .eq("id", session.user.id)
    .single();
  user = data;
}

// Obtener categor√≠as
const { data: categories } = await supabase
  .from("giftcard_categories")
  .select("*")
  .eq("is_active", true)
  .order("name");

// Obtener giftcards
const categoryFilter = Astro.url.searchParams.get("categoria");
let query = supabase
  .from("giftcards")
  .select(
    `
    *,
    category:giftcard_categories(*)
  `,
  )
  .eq("is_active", true)
  .gt("stock", 0);

if (categoryFilter) {
  query = query.eq("category_id", categoryFilter);
}

const { data: giftcards } = await query.order("denomination");
---

<Layout title="Tienda">
  <div class="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800">
    <StoreNavbar user={user} activePage="tienda" />

    <main class="container mx-auto px-4 py-12">
      <!-- Banner -->
      <div
        class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-primary to-red-700 p-8 md:p-12 mb-8"
      >
        <div class="relative z-10">
          <h1 class="text-3xl md:text-4xl font-bold text-white mb-4">
            üéÆ GiftCards para Gamers
          </h1>
          <p class="text-white/80 max-w-xl">
            Compra tus giftcards favoritas de Roblox, PlayStation, Xbox y m√°s.
            Entrega instant√°nea y precios incre√≠bles.
          </p>
        </div>
        <div
          class="absolute right-0 top-0 w-64 h-64 bg-white/10 rounded-full blur-3xl"
        >
        </div>
      </div>

      <div class="flex flex-col lg:flex-row gap-8">
        <!-- Sidebar - Categor√≠as -->
        <aside class="lg:w-64 shrink-0">
          <div
            class="sticky top-24 bg-slate-800/50 rounded-xl p-6 border border-white/10"
          >
            <h2 class="text-lg font-semibold text-white mb-4">Categor√≠as</h2>
            <nav class="space-y-2">
              <a
                href="/tienda"
                class:list={[
                  "block px-4 py-2 rounded-lg text-sm transition-all",
                  !categoryFilter
                    ? "bg-primary text-white"
                    : "text-gray-400 hover:bg-white/5 hover:text-white",
                ]}
              >
                Todas
              </a>
              {
                categories?.map((cat: GiftCardCategory) => (
                  <a
                    href={`/tienda?categoria=${cat.id}`}
                    class:list={[
                      "block px-4 py-2 rounded-lg text-sm transition-all",
                      categoryFilter === cat.id
                        ? "bg-primary text-white"
                        : "text-gray-400 hover:bg-white/5 hover:text-white",
                    ]}
                  >
                    {cat.name}
                  </a>
                ))
              }
            </nav>
          </div>
        </aside>

        <!-- Grid de GiftCards -->
        <div class="flex-1">
          {
            giftcards && giftcards.length > 0 ? (
              <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6">
                {giftcards.map((card: any) => (
                  <a
                    href={`/giftcard/${card.id}`}
                    class="group bg-slate-800/50 rounded-xl overflow-hidden border border-white/10 hover:border-primary/50 transition-all hover:scale-[1.02] hover:shadow-xl"
                  >
                    <div class="relative aspect-video bg-gradient-to-br from-primary/20 to-primary/5 p-6 flex items-center justify-center">
                      {card.image_url ? (
                        <img
                          src={card.image_url}
                          alt={card.name}
                          class="h-16 object-contain"
                        />
                      ) : (
                        <div class="text-4xl font-bold text-white/50">
                          {card.name?.charAt(0)}
                        </div>
                      )}
                      {card.original_price &&
                        card.original_price > card.price && (
                          <span class="absolute top-4 right-4 bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-full">
                            -
                            {Math.round(
                              (1 - card.price / card.original_price) * 100,
                            )}
                            %
                          </span>
                        )}
                    </div>
                    <div class="p-5">
                      <div class="flex items-start justify-between gap-4 mb-3">
                        <div>
                          <h3 class="font-semibold text-white group-hover:text-primary transition-colors">
                            {card.name}
                          </h3>
                          <p class="text-sm text-gray-400">
                            {card.category?.name}
                          </p>
                        </div>
                        <span class="bg-primary/20 text-primary text-sm font-bold px-3 py-1 rounded-lg">
                          ${card.denomination}
                        </span>
                      </div>
                      <div class="flex items-center justify-between">
                        <div>
                          <span class="text-xl font-bold text-white">
                            ${card.price.toFixed(2)}
                          </span>
                          {card.original_price &&
                            card.original_price > card.price && (
                              <span class="text-sm text-gray-500 line-through ml-2">
                                ${card.original_price.toFixed(2)}
                              </span>
                            )}
                        </div>
                        <span
                          class:list={[
                            "text-xs px-2 py-1 rounded-full",
                            card.stock > 10
                              ? "bg-green-500/20 text-green-400"
                              : card.stock > 0
                                ? "bg-yellow-500/20 text-yellow-400"
                                : "bg-red-500/20 text-red-400",
                          ]}
                        >
                          {card.stock > 10
                            ? "En Stock"
                            : card.stock > 0
                              ? `Quedan ${card.stock}`
                              : "Agotado"}
                        </span>
                      </div>
                    </div>
                  </a>
                ))}
              </div>
            ) : (
              <div class="text-center py-20">
                <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6">
                  <Inbox className="w-12 h-12 text-gray-600" client:load />
                </div>
                <h3 class="text-xl font-semibold text-white mb-2">
                  No hay giftcards disponibles
                </h3>
                <p class="text-gray-400">
                  Vuelve pronto para ver nuevos productos
                </p>
              </div>
            )
          }
        </div>
      </div>
    </main>
  </div>
</Layout>
