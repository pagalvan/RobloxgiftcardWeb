---
import Layout from "@/layouts/Layout.astro";
import { supabase } from "@/lib/supabase";


// Verificar si el usuario ya está autenticado
const {
  data: { session },
} = await supabase.auth.getSession();
if (session) {
  return Astro.redirect("/tienda");
}

// Manejar el registro
let error = "";
let success = false;

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const email = formData.get("email")?.toString() || "";
    const password = formData.get("password")?.toString() || "";
    const confirmPassword = formData.get("confirmPassword")?.toString() || "";
    const fullName = formData.get("fullName")?.toString() || "";

    if (password !== confirmPassword) {
      error = "Las contraseñas no coinciden";
    } else if (password.length < 6) {
      error = "La contraseña debe tener al menos 6 caracteres";
    } else {
      const { data, error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName,
          },
        },
      });

      if (signUpError) {
        error = signUpError.message;
      } else {
        success = true;
      }
    }
  } catch (e: any) {
    error = e.message || "Error al registrarse";
  }
}
---

<Layout title="Registrarse">
  <div
    class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 flex items-center justify-center p-4"
  >
    <div class="w-full max-w-md">
      <!-- Logo -->
      <div class="text-center mb-8">
        <a href="/" class="inline-flex items-center logo-container">
          <img src="/Reload.svg" alt="Reload" class="h-14 w-auto logo-icon" />
          <img src="/images/ELOAD.png" alt="ELOAD" class="h-7 logo-text" />
        </a>
      </div>

      <!-- Card -->
      <div
        class="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20 shadow-2xl"
      >
        <h1 class="text-2xl font-bold text-white text-center mb-2">
          Crear Cuenta
        </h1>
        <p class="text-gray-400 text-center mb-8">
          Regístrate para acceder a las mejores ofertas
        </p>

        {
          success ? (
            <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-6">
              <p class="text-green-400 text-center">
                ¡Registro exitoso! Revisa tu correo para confirmar tu cuenta.
              </p>
              <div class="text-center mt-4">
                <a href="/auth/login" class="text-primary hover:underline">
                  Ir a iniciar sesión
                </a>
              </div>
            </div>
          ) : (
            <form method="POST" class="space-y-5">
              {error && (
                <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-4">
                  <p class="text-red-400 text-sm text-center">{error}</p>
                </div>
              )}

              <div>
                <label
                  for="fullName"
                  class="block text-sm font-medium text-gray-300 mb-2"
                >
                  Nombre Completo
                </label>
                <input
                  type="text"
                  id="fullName"
                  name="fullName"
                  required
                  class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  placeholder="Tu nombre"
                />
              </div>

              <div>
                <label
                  for="email"
                  class="block text-sm font-medium text-gray-300 mb-2"
                >
                  Correo Electrónico
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  placeholder="tu@email.com"
                />
              </div>

              <div>
                <label
                  for="password"
                  class="block text-sm font-medium text-gray-300 mb-2"
                >
                  Contraseña
                </label>
                <input
                  type="password"
                  id="password"
                  name="password"
                  required
                  minlength="6"
                  class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  placeholder="••••••••"
                />
              </div>

              <div>
                <label
                  for="confirmPassword"
                  class="block text-sm font-medium text-gray-300 mb-2"
                >
                  Confirmar Contraseña
                </label>
                <input
                  type="password"
                  id="confirmPassword"
                  name="confirmPassword"
                  required
                  minlength="6"
                  class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                  placeholder="••••••••"
                />
              </div>

              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="terms"
                  required
                  class="mt-1 w-4 h-4 rounded border-white/20 bg-white/5 text-primary focus:ring-primary"
                />
                <label for="terms" class="text-sm text-gray-400">
                  Acepto los{" "}
                  <a href="#" class="text-primary hover:underline">
                    términos y condiciones
                  </a>{" "}
                  y la{" "}
                  <a href="#" class="text-primary hover:underline">
                    política de privacidad
                  </a>
                </label>
              </div>

              <button
                type="submit"
                class="w-full bg-primary hover:bg-primary/90 text-white py-3 rounded-lg font-semibold transition-all hover:scale-[1.02] hover:shadow-lg hover:shadow-primary/50"
              >
                Crear Cuenta
              </button>
            </form>
          )
        }

        <div class="mt-6 text-center">
          <p class="text-gray-400 text-sm">
            ¿Ya tienes cuenta?{" "}
            <a
              href="/auth/login"
              class="text-primary hover:underline font-medium"
            >
              Iniciar Sesión
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .logo-container {
    position: relative;
    overflow: hidden;
    padding-right: 0;
    transition: padding-right 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .logo-container:hover {
    padding-right: 110px;
  }
  
  .logo-icon {
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    z-index: 2;
  }
  
  .logo-text {
    position: absolute;
    left: 30px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0;
    z-index: 1;
    transition: left 0.5s cubic-bezier(0.34, 1.56, 0.64, 1),
                opacity 0.3s ease-out;
  }
  
  .logo-container:hover .logo-icon {
    transform: scale(1.05);
  }
  
  .logo-container:hover .logo-text {
    left: 60px;
    opacity: 1;
  }
</style>
