---
import Layout from "@/layouts/Layout.astro";
import { supabase, type UserProfile } from "@/lib/supabase";
import AdminSidebar from "@/components/AdminSidebar.astro";

// Verificar autenticaci√≥n y rol de admin
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/auth/login");
}

const { data: user } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", session.user.id)
  .single();

if (user?.role !== "admin") {
  return Astro.redirect("/tienda");
}

// Manejar acciones
let message = "";
let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action")?.toString();

  if (action === "update_role") {
    const userId = formData.get("user_id")?.toString();
    const newRole = formData.get("role")?.toString();

    const { error: updateError } = await supabase
      .from("profiles")
      .update({ role: newRole })
      .eq("id", userId);

    if (updateError) {
      error = updateError.message;
    } else {
      message = "Rol actualizado exitosamente";
    }
  }
}

// Obtener usuarios
const { data: users } = await supabase
  .from("profiles")
  .select("*")
  .order("created_at", { ascending: false });
---

<Layout title="Gestionar Usuarios">
  <div class="min-h-screen bg-slate-900">
    <AdminSidebar activePage="usuarios" user={user} />

    <!-- Main Content -->
    <main class="ml-64 p-8">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white">Usuarios</h1>
        <p class="text-gray-400 mt-1">Gestiona los roles de los usuarios</p>
      </div>

      {
        message && (
          <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-6">
            <p class="text-green-400">{message}</p>
          </div>
        )
      }

      {
        error && (
          <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-4 mb-6">
            <p class="text-red-400">{error}</p>
          </div>
        )
      }

      <!-- Stats -->
      <div class="grid sm:grid-cols-3 gap-6 mb-8">
        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10">
          <p class="text-3xl font-bold text-white">
            {
              users?.filter((u: UserProfile) => u.role === "cliente").length ||
                0
            }
          </p>
          <p class="text-sm text-gray-400">Clientes</p>
        </div>
        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10">
          <p class="text-3xl font-bold text-white">
            {
              users?.filter((u: UserProfile) => u.role === "proveedor")
                .length || 0
            }
          </p>
          <p class="text-sm text-gray-400">Proveedores</p>
        </div>
        <div class="bg-slate-800/50 rounded-xl p-6 border border-white/10">
          <p class="text-3xl font-bold text-white">
            {users?.filter((u: UserProfile) => u.role === "admin").length || 0}
          </p>
          <p class="text-sm text-gray-400">Administradores</p>
        </div>
      </div>

      <!-- Tabla de Usuarios -->
      <div
        class="bg-slate-800/50 rounded-xl border border-white/10 overflow-hidden"
      >
        <table class="w-full">
          <thead class="bg-slate-800">
            <tr>
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Usuario</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Email</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Rol</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Fecha Registro</th
              >
              <th
                class="px-6 py-4 text-right text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Cambiar Rol</th
              >
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {
              users && users.length > 0 ? (
                users.map((u: UserProfile) => (
                  <tr class="hover:bg-white/5">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-primary/20 rounded-full flex items-center justify-center text-primary font-bold">
                          {u.full_name?.charAt(0).toUpperCase() || "?"}
                        </div>
                        <span class="text-white font-medium">
                          {u.full_name || "Sin nombre"}
                        </span>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-gray-400">{u.email}</td>
                    <td class="px-6 py-4">
                      <span
                        class:list={[
                          "px-3 py-1 rounded-full text-xs font-medium",
                          u.role === "admin"
                            ? "bg-purple-500/20 text-purple-400"
                            : u.role === "proveedor"
                              ? "bg-blue-500/20 text-blue-400"
                              : "bg-green-500/20 text-green-400",
                        ]}
                      >
                        {u.role === "admin"
                          ? "Administrador"
                          : u.role === "proveedor"
                            ? "Proveedor"
                            : "Cliente"}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-gray-400">
                      {new Date(u.created_at).toLocaleDateString("es-ES")}
                    </td>
                    <td class="px-6 py-4 text-right">
                      {u.id !== session.user.id ? (
                        <form
                          method="POST"
                          class="inline-flex items-center gap-2"
                        >
                          <input
                            type="hidden"
                            name="action"
                            value="update_role"
                          />
                          <input type="hidden" name="user_id" value={u.id} />
                          <select
                            name="role"
                            class="bg-slate-900 border border-white/10 rounded-lg px-3 py-1 text-sm text-white focus:outline-none focus:ring-2 focus:ring-primary"
                          >
                            <option
                              value="cliente"
                              selected={u.role === "cliente"}
                            >
                              Cliente
                            </option>
                            <option
                              value="proveedor"
                              selected={u.role === "proveedor"}
                            >
                              Proveedor
                            </option>
                            <option value="admin" selected={u.role === "admin"}>
                              Admin
                            </option>
                          </select>
                          <button
                            type="submit"
                            class="bg-primary/20 hover:bg-primary/30 text-primary px-3 py-1 rounded-lg text-sm transition-all"
                          >
                            Guardar
                          </button>
                        </form>
                      ) : (
                        <span class="text-gray-500 text-sm">Tu cuenta</span>
                      )}
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colspan="5" class="px-6 py-12 text-center text-gray-400">
                    No hay usuarios registrados
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
    </main>
  </div>
</Layout>
