---
import Layout from "@/layouts/Layout.astro";
import { supabase, type GiftCardCategory } from "@/lib/supabase";
import { Switch } from "@/components/ui/switch";
import { Plus, Pencil, Trash2 } from "lucide-react";
import AdminSidebar from "@/components/AdminSidebar.astro";

// Verificar autenticación y rol de admin
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/auth/login");
}

const { data: user } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", session.user.id)
  .single();

if (user?.role !== "admin") {
  return Astro.redirect("/tienda");
}

// Manejar acciones
let message = "";
let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action")?.toString();

  if (action === "create") {
    const name = formData.get("name")?.toString() || "";
    const categoryId = formData.get("category_id")?.toString() || "";
    const denomination = parseFloat(
      formData.get("denomination")?.toString() || "0",
    );
    const price = parseFloat(formData.get("price")?.toString() || "0");
    const description = formData.get("description")?.toString() || "";
    const imageUrl = formData.get("image_url")?.toString() || "";
    const isActive = formData.get("is_active") === "on";

    const { error: createError } = await supabase.from("giftcards").insert({
      name,
      category_id: categoryId,
      denomination,
      price,
      description,
      image_url: imageUrl,
      currency: "COP",
      stock: 0,
      is_active: isActive,
    });

    if (createError) {
      error = createError.message;
    } else {
      message = "GiftCard creada exitosamente";
    }
  } else if (action === "delete") {
    const id = formData.get("id")?.toString();
    const { error: deleteError } = await supabase
      .from("giftcards")
      .delete()
      .eq("id", id);

    if (deleteError) {
      error = deleteError.message;
    } else {
      message = "GiftCard eliminada";
    }
  } else if (action === "toggle") {
    const id = formData.get("id")?.toString();
    const isActive = formData.get("is_active") === "true";

    await supabase
      .from("giftcards")
      .update({ is_active: !isActive })
      .eq("id", id);

    message = "Estado actualizado";
  } else if (action === "update") {
    const id = formData.get("id")?.toString();
    const name = formData.get("name")?.toString();
    const categoryId = formData.get("category_id")?.toString();
    const denomination = parseFloat(
      formData.get("denomination")?.toString() || "0",
    );
    const price = parseFloat(formData.get("price")?.toString() || "0");
    const description = formData.get("description")?.toString();
    const imageUrl = formData.get("image_url")?.toString();
    const isActive = formData.get("is_active") === "on";

    const { error: updateError } = await supabase
      .from("giftcards")
      .update({
        name,
        category_id: categoryId,
        denomination,
        price,
        description,
        image_url: imageUrl,
        is_active: isActive,
      })
      .eq("id", id);

    if (updateError) {
      error = updateError.message;
    } else {
      message = "GiftCard actualizada exitosamente";
    }
  }
}

// Obtener categorías
const { data: categories } = await supabase
  .from("giftcard_categories")
  .select("*")
  .order("name");

// Obtener giftcards
const { data: giftcards } = await supabase
  .from("giftcards")
  .select(
    `
    *,
    category:giftcard_categories(name)
  `,
  )
  .order("created_at", { ascending: false });
---

<Layout title="Gestionar GiftCards">
  <div class="min-h-screen bg-slate-900">
    <AdminSidebar activePage="giftcards" user={user} />

    <!-- Main Content -->
    <main class="ml-64 p-8">
      <div class="flex items-center justify-between mb-8">
        <div>
          <h1 class="text-3xl font-bold text-white">GiftCards</h1>
          <p class="text-gray-400 mt-1">Gestiona los productos de la tienda</p>
        </div>
        <button
          onclick="document.getElementById('createModal').classList.remove('hidden')"
          class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium flex items-center gap-2"
        >
          <Plus className="w-5 h-5" client:load />
          Nueva GiftCard
        </button>
      </div>

      {
        message && (
          <div class="bg-green-500/20 border border-green-500/50 rounded-lg p-4 mb-6">
            <p class="text-green-400">{message}</p>
          </div>
        )
      }

      {
        error && (
          <div class="bg-red-500/20 border border-red-500/50 rounded-lg p-4 mb-6">
            <p class="text-red-400">{error}</p>
          </div>
        )
      }

      <!-- Tabla de GiftCards -->
      <div
        class="bg-slate-800/50 rounded-xl border border-white/10 overflow-hidden"
      >
        <table class="w-full">
          <thead class="bg-slate-800">
            <tr>
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Producto</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Categoría</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Valor</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Precio</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Stock</th
              >
              <th
                class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Estado</th
              >
              <th
                class="px-6 py-4 text-right text-xs font-medium text-gray-400 uppercase tracking-wider"
                >Acciones</th
              >
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {
              giftcards && giftcards.length > 0 ? (
                giftcards.map((card: any) => (
                  <tr class="hover:bg-white/5">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-primary/20 to-primary/5 rounded-lg flex items-center justify-center">
                          {card.image_url ? (
                            <img
                              src={card.image_url}
                              alt={card.name}
                              class="h-6 object-contain"
                            />
                          ) : (
                            <span class="text-white/30 font-bold">
                              {card.name?.charAt(0)}
                            </span>
                          )}
                        </div>
                        <span class="text-white font-medium">{card.name}</span>
                      </div>
                    </td>
                    <td class="px-6 py-4 text-gray-400">
                      {card.category?.name || "-"}
                    </td>
                    <td class="px-6 py-4 text-white">{card.denomination}</td>
                    <td class="px-6 py-4 text-green-400 font-semibold">
                      ${new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(card.price)}
                    </td>
                    <td class="px-6 py-4">
                      <span
                        class:list={[
                          "px-2 py-1 rounded-full text-xs font-medium",
                          card.stock > 10
                            ? "bg-green-500/20 text-green-400"
                            : card.stock > 0
                              ? "bg-yellow-500/20 text-yellow-400"
                              : "bg-red-500/20 text-red-400",
                        ]}
                      >
                        {card.stock}
                      </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                      <form method="POST" class="inline-flex items-center">
                        <input type="hidden" name="action" value="toggle" />
                        <input type="hidden" name="id" value={card.id} />
                        <input
                          type="hidden"
                          name="is_active"
                          value={card.is_active.toString()}
                        />
                        <Switch
                          checked={card.is_active}
                          type="submit"
                          className="data-[state=checked]:bg-primary data-[state=unchecked]:bg-slate-700"
                          client:load
                        />
                      </form>
                    </td>
                    <td class="px-6 py-4 text-right">
                      <div class="flex items-center justify-end gap-2">
                        <button
                          onclick={`openEditModal(${JSON.stringify(card)})`}
                          class="p-2 text-gray-400 hover:text-white hover:bg-white/10 rounded-lg transition-all"
                        >
                          <Pencil className="w-4 h-4" client:load />
                        </button>
                        <button
                          type="button"
                          onclick={`openDeleteModal('${card.id}')`}
                          class="p-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg transition-all"
                        >
                          <Trash2 className="w-4 h-4" client:load />
                        </button>
                      </div>
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td colspan="7" class="px-6 py-12 text-center text-gray-400">
                    No hay giftcards. Crea la primera haciendo clic en "Nueva
                    GiftCard"
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Modal Crear -->
</Layout>

<script>
  // Funciones para el modal de edición
  (window as any).openEditModal = (data: any) => {
    const modal = document.getElementById("editModal");

    // Set form action inputs
    (document.getElementById("edit_id") as HTMLInputElement).value = data.id;
    (document.getElementById("edit_name") as HTMLInputElement).value =
      data.name;
    (document.getElementById("edit_category_id") as HTMLSelectElement).value =
      data.category_id;
    (document.getElementById("edit_denomination") as HTMLInputElement).value =
      data.denomination;
    (document.getElementById("edit_price") as HTMLInputElement).value =
      data.price;
    (document.getElementById("edit_image_url") as HTMLInputElement).value =
      data.image_url || "";
    (document.getElementById("edit_description") as HTMLTextAreaElement).value =
      data.description || "";
    (document.getElementById("edit_is_active") as HTMLInputElement).checked =
      data.is_active;

    // Sync shadcn Switch state visually
    const switchBtn = document.getElementById("edit_is_active_switch");
    if (switchBtn) {
      switchBtn.setAttribute(
        "data-state",
        data.is_active ? "checked" : "unchecked",
      );
      const thumb = switchBtn.querySelector("span");
      if (thumb) {
        thumb.setAttribute(
          "data-state",
          data.is_active ? "checked" : "unchecked",
        );
      }
    }

    modal?.classList.remove("hidden");
  };

  (window as any).closeEditModal = () => {
    document.getElementById("editModal")?.classList.add("hidden");
  };

  // Funciones para el modal de eliminar
  (window as any).openDeleteModal = (id: string) => {
    const modal = document.getElementById("deleteModal");
    (document.getElementById("delete_id") as HTMLInputElement).value = id;
    modal?.classList.remove("hidden");
  };

  (window as any).closeDeleteModal = () => {
    document.getElementById("deleteModal")?.classList.add("hidden");
  };
</script>

<!-- Modal Crear -->
<div id="createModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div
      class="fixed inset-0 bg-black/70"
      onclick="document.getElementById('createModal').classList.add('hidden')"
    >
    </div>
    <div
      class="relative bg-slate-800 rounded-xl w-full max-w-md p-6 border border-white/10"
    >
      <h2 class="text-xl font-bold text-white mb-6">Nueva GiftCard</h2>
      <form method="POST" class="space-y-4">
        <input type="hidden" name="action" value="create" />

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Nombre</label
          >
          <input
            type="text"
            name="name"
            required
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="Ej: Roblox Gift Card"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Categoría</label
          >
          <select
            name="category_id"
            required
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
          >
            <option value="">Seleccionar...</option>
            {
              categories?.map((cat: GiftCardCategory) => (
                <option value={cat.id}>{cat.name}</option>
              ))
            }
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Denominación</label
            >
            <input
              type="number"
              name="denomination"
              required
              min="1"
              step="1"
              class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="400"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Precio COP</label
            >
            <input
              type="number"
              name="price"
              required
              min="1"
              step="1"
              class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
              placeholder="42000"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >URL de Imagen</label
          >
          <input
            type="url"
            name="image_url"
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
            placeholder="https://..."
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Descripción</label
          >
          <textarea
            name="description"
            rows="3"
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"
            placeholder="Descripción del producto..."></textarea>
        </div>

        <div
          class="flex items-center justify-between p-4 bg-slate-900/50 rounded-xl border border-white/5 group hover:border-primary/50 transition-all"
        >
          <div>
            <label class="text-sm font-semibold text-white block"
              >Producto Activo</label
            >
            <p class="text-xs text-gray-400">
              ¿Mostrar este producto en la tienda?
            </p>
          </div>
          <Switch
            id="create_is_active_switch"
            checked={true}
            onCheckedChange={(checked: boolean) => {
              const input = document.getElementById(
                "create_is_active",
              ) as HTMLInputElement;
              if (input) input.checked = checked;
            }}
            className="data-[state=checked]:bg-primary data-[state=unchecked]:bg-slate-700"
            client:load
          />
          <input
            type="checkbox"
            name="is_active"
            id="create_is_active"
            class="hidden"
            checked
          />
        </div>

        <div class="flex gap-3 pt-4">
          <button
            type="button"
            onclick="document.getElementById('createModal').classList.add('hidden')"
            class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-all"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all"
          >
            Crear GiftCard
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Editar -->
<div id="editModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/70" onclick="window.closeEditModal()">
    </div>
    <div
      class="relative bg-slate-800 rounded-xl w-full max-w-md p-6 border border-white/10"
    >
      <h2 class="text-xl font-bold text-white mb-6">Editar GiftCard</h2>
      <form method="POST" id="editForm" class="space-y-4">
        <input type="hidden" name="action" value="update" />
        <input type="hidden" name="id" id="edit_id" />

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Nombre</label
          >
          <input
            type="text"
            name="name"
            id="edit_name"
            required
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Categoría</label
          >
          <select
            name="category_id"
            id="edit_category_id"
            required
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
          >
            <option value="">Seleccionar...</option>
            {
              categories?.map((cat: GiftCardCategory) => (
                <option value={cat.id}>{cat.name}</option>
              ))
            }
          </select>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Denominación</label
            >
            <input
              type="number"
              name="denomination"
              id="edit_denomination"
              required
              min="1"
              step="1"
              class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2"
              >Precio COP</label
            >
            <input
              type="number"
              name="price"
              id="edit_price"
              required
              min="1"
              step="1"
              class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >URL de Imagen</label
          >
          <input
            type="url"
            name="image_url"
            id="edit_image_url"
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-300 mb-2"
            >Descripción</label
          >
          <textarea
            name="description"
            id="edit_description"
            rows="3"
            class="w-full px-4 py-2 bg-slate-900 border border-white/10 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary resize-none"
          ></textarea>
        </div>

        <div
          class="flex items-center justify-between p-4 bg-slate-900/50 rounded-xl border border-white/5 group hover:border-primary/50 transition-all"
        >
          <div>
            <label class="text-sm font-semibold text-white block"
              >Producto Activo</label
            >
            <p class="text-xs text-gray-400">
              ¿Mostrar este producto en la tienda?
            </p>
          </div>
          <Switch
            id="edit_is_active_switch"
            onCheckedChange={(checked: boolean) => {
              const input = document.getElementById(
                "edit_is_active",
              ) as HTMLInputElement;
              if (input) input.checked = checked;
            }}
            className="data-[state=checked]:bg-primary data-[state=unchecked]:bg-slate-700"
            client:load
          />
          <input
            type="checkbox"
            name="is_active"
            id="edit_is_active"
            class="hidden"
          />
        </div>

        <div class="flex gap-3 pt-4">
          <button
            type="button"
            onclick="window.closeEditModal()"
            class="flex-1 px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-all"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-all"
          >
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Eliminar -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/70" onclick="window.closeDeleteModal()">
    </div>
    <div
      class="relative bg-slate-800 rounded-xl w-full max-w-sm p-6 border border-white/10"
    >
      <div class="text-center">
        <div
          class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4"
        >
          <Trash2 className="w-8 h-8 text-red-500" client:load />
        </div>
        <h3 class="text-xl font-bold text-white mb-2">¿Eliminar GiftCard?</h3>
        <p class="text-gray-400 mb-6">
          Esta acción no se puede deshacer. ¿Estás seguro de que quieres
          continuar?
        </p>

        <form method="POST" class="space-y-3">
          <input type="hidden" name="action" value="delete" />
          <input type="hidden" name="id" id="delete_id" />

          <button
            type="submit"
            class="w-full px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-medium"
          >
            Sí, eliminar
          </button>
          <button
            type="button"
            onclick="window.closeDeleteModal()"
            class="w-full px-4 py-2 bg-white/10 text-white rounded-lg hover:bg-white/20 transition-all"
          >
            Cancelar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
