---
import Layout from "@/layouts/Layout.astro";
import AdminSidebar from "@/components/AdminSidebar.astro";
import { supabase } from "@/lib/supabase";
import { Settings, Phone, User, Save, CheckCircle2, MessageCircle } from "lucide-react";

// Verificar autenticación y rol admin
const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect('/auth/login');
}

const { data: user } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', session.user.id)
  .single();

if (!user || user.role !== 'admin') {
  return Astro.redirect('/');
}

// Obtener configuración actual
const { data: settings } = await supabase
  .from('store_settings')
  .select('*');

const getSettingValue = (key: string) => {
  return settings?.find(s => s.setting_key === key)?.setting_value || '';
};

// Manejar actualización
let successMessage = '';
let errorMessage = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const newNequiPhone = formData.get('nequi_phone') as string;
    const newNequiName = formData.get('nequi_name') as string;
    const newBotToken = formData.get('telegram_bot_token') as string;
    const newChatId = formData.get('telegram_chat_id') as string;

    // Actualizar cada configuración
    const updates = [
      { key: 'nequi_phone', value: newNequiPhone },
      { key: 'nequi_name', value: newNequiName },
      { key: 'telegram_bot_token', value: newBotToken },
      { key: 'telegram_chat_id', value: newChatId },
    ];

    for (const update of updates) {
      if (update.value !== null) { // Solo actualizar si se envía (aunque sea string vacío)
        const { error } = await supabase
          .from('store_settings')
          .upsert({
            setting_key: update.key,
            setting_value: update.value,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'setting_key'
          });

        if (error) throw error;
      }
    }

    successMessage = '¡Configuración guardada correctamente!';
  } catch (error: any) {
    errorMessage = 'Error al guardar: ' + (error.message || 'Error desconocido');
  }
}

// Recargar configuración después de guardar
const { data: updatedSettings } = await supabase
  .from('store_settings')
  .select('*');

const getCurrentValue = (key: string) => {
  return updatedSettings?.find(s => s.setting_key === key)?.setting_value || '';
};
---

<Layout title="Configuración - Admin">
  <div class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 flex">
    <AdminSidebar activePage="configuracion" user={user} />
    
    <main class="flex-1 p-8">
      <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white flex items-center gap-3">
            <Settings className="w-8 h-8 text-primary" />
            Configuración
          </h1>
          <p class="text-gray-400 mt-1">Configura los datos de pago y notificaciones</p>
        </div>

        {successMessage && (
          <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 mb-6 flex items-center gap-3">
            <CheckCircle2 className="w-5 h-5 text-green-400" />
            <span class="text-green-400">{successMessage}</span>
          </div>
        )}

        {errorMessage && (
          <div class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6">
            <span class="text-red-400">{errorMessage}</span>
          </div>
        )}

        <form method="POST" class="space-y-6">
          <!-- Sección Nequi -->
          <div class="bg-slate-800/50 rounded-2xl border border-white/10 p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center p-2">
                <img src="/images/nequilogo.png" alt="Nequi" class="w-full h-full object-contain" />
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Datos de Nequi</h2>
                <p class="text-sm text-gray-400">Información que verán los clientes al pagar</p>
              </div>
            </div>

            <div class="space-y-4">
              <!-- Número Nequi -->
              <div>
                <label for="nequi_phone" class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                  <Phone className="w-4 h-4" />
                  Número de Nequi
                </label>
                <input
                  type="text"
                  id="nequi_phone"
                  name="nequi_phone"
                  value={getCurrentValue('nequi_phone')}
                  placeholder="3001234567"
                  class="w-full px-4 py-3 bg-slate-900/50 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                />
                <p class="text-xs text-gray-500 mt-1">Solo el número, sin código de país</p>
              </div>

              <!-- Nombre titular -->
              <div>
                <label for="nequi_name" class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                  <User className="w-4 h-4" />
                  Nombre del titular
                </label>
                <input
                  type="text"
                  id="nequi_name"
                  name="nequi_name"
                  value={getCurrentValue('nequi_name')}
                  placeholder="Tu nombre completo"
                  class="w-full px-4 py-3 bg-slate-900/50 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                />
                <p class="text-xs text-gray-500 mt-1">Nombre que aparece en tu cuenta Nequi</p>
              </div>
            </div>
          </div>

          <!-- Sección Telegram -->
          <div class="bg-slate-800/50 rounded-2xl border border-white/10 p-6">
            <div class="flex items-center gap-3 mb-6">
              <div class="w-12 h-12 bg-sky-500 rounded-xl flex items-center justify-center p-2">
                <MessageCircle className="w-8 h-8 text-white" />
              </div>
              <div>
                <h2 class="text-xl font-bold text-white">Bot de Telegram</h2>
                <p class="text-sm text-gray-400">Recibe notificaciones y aprueba pagos desde Telegram</p>
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <label for="telegram_bot_token" class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                  <Settings className="w-4 h-4" />
                  Bot Token (BotFather)
                </label>
                <input
                  type="text"
                  id="telegram_bot_token"
                  name="telegram_bot_token"
                  value={getCurrentValue('telegram_bot_token')}
                  placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11"
                  class="w-full px-4 py-3 bg-slate-900/50 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Obtenlo creando un bot con <a href="https://t.me/BotFather" target="_blank" class="text-sky-400 hover:underline">@BotFather</a>
                </p>
              </div>

              <div>
                <label for="telegram_chat_id" class="flex items-center gap-2 text-sm font-medium text-gray-300 mb-2">
                  <User className="w-4 h-4" />
                  Chat ID (Tu ID)
                </label>
                <input
                  type="text"
                  id="telegram_chat_id"
                  name="telegram_chat_id"
                  value={getCurrentValue('telegram_chat_id')}
                  placeholder="123456789"
                  class="w-full px-4 py-3 bg-slate-900/50 border border-white/10 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Obtenlo escribiéndole a <a href="https://t.me/userinfobot" target="_blank" class="text-sky-400 hover:underline">@userinfobot</a>
                </p>
              </div>
            </div>
          </div>

          <!-- Preview -->
          <div class="bg-slate-800/50 rounded-2xl border border-white/10 p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Vista previa para el cliente</h3>
            <div class="bg-slate-900/50 rounded-xl p-4 space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Número Nequi</span>
                <span id="preview-phone" class="text-white font-mono font-bold">{getCurrentValue('nequi_phone') || '---'}</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Nombre</span>
                <span id="preview-name" class="text-white font-medium">{getCurrentValue('nequi_name') || '---'}</span>
              </div>
            </div>
          </div>

          <!-- Botón guardar -->
          <button
            type="submit"
            class="w-full py-4 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl transition-all flex items-center justify-center gap-2"
          >
            <Save className="w-5 h-5" />
            Guardar Configuración
          </button>
        </form>
      </div>
    </main>
  </div>
</Layout>

<script>
  // Actualizar preview en tiempo real
  const phoneInput = document.getElementById('nequi_phone') as HTMLInputElement;
  const nameInput = document.getElementById('nequi_name') as HTMLInputElement;
  const previewPhone = document.getElementById('preview-phone');
  const previewName = document.getElementById('preview-name');

  phoneInput?.addEventListener('input', () => {
    if (previewPhone) previewPhone.textContent = phoneInput.value || '---';
  });

  nameInput?.addEventListener('input', () => {
    if (previewName) previewName.textContent = nameInput.value || '---';
  });
</script>
